function [t_out, E_out] = halfWP_PAC(t_in, E_in, alpha, hwpType, dispersion)
%% Code to apply a half waveplate to an incoming electric field. The code
% uses Jones formalism for calculations, and uses the full phase applied by
% the waveplate, i.e. it accounts for dispersion.
%
% Input:    - t_in: list of times in seconds
%           - E_in: complex electric field along x and y (therefore nx2 or
%                   2xn (conversion automatically done in code)
%           - alpha: Angle (in radian) of the waveplate
%           - hwpType: Possibilities 'RAC5_2' (achromatic)
%                                    'RSU1_2' (superachro, low wavelength)
%                                    'RSU2_2' (superachro, high wavelength,
%                                       probably the correct one)
%           - dispersion: Bool to know if could should be executed or not
%               (useful to engage or disengage dispersion in larger codes)
%
% Outputs:  - t_out: Time list
%           - E_out: Output complex electric field (2 x n)
%
% Example:
%     angle_HWP           = 10 * pi / 180;
%     angle_QWP           = 79 * pi / 180;
%     angle_parasitic_WP  = 15 * pi / 180;
%     retardance_parasitic_WP = 0 * pi / 180;
%     lambda_0            = 800e-9;
%     lambda_list         = 500e-9 : 1e-9 : 1000e-9; % A broad range: it should cover the entire spectrum. It will be used to interpolate data
%     tau_FWHM            = 10e-15;
%     thickness_window    = 5e-3;
%     t                   = (-200 : 0.1 : 200) * 1e-15;
%     dispersion          = 1;
%     hwpType             = 'RAC5_2'; % 'ideal', 'RAC5_2' 'RSU1_2', 'RSU2_2' (we have achromatic and superachro range 2 RSU2_2)
%     qwpType             = 'RAC5_4'; % 'ideal', 'RAC5_4' 'RSU1_4', 'RSU2_4' (we have achromatic and superachro range 2 RSU2_4)
%     time_window         = 2.7e-15; % To look at the instantaneous ellipticity for a particular cycle, default: [-2.7e-15   2.7e-15] (1 cycle, 1 cycle after)
%     tau                 = tau_FWHM / (2*sqrt(2*log(2)));
%     IEnv                = exp(-t.^2 ./ (2*tau^2));
%     E                   = zeros(2, length(t));
%     E(1,:)              = sqrt(IEnv) .* exp(1i*(2*pi*299792458/lambda_0 * t));
%     [~, data_UVFS]      = getRefractiveIndex('UVFS', lambda_list);
%     [~, spectral_phase] = getGDCurve(lambda_list, lambda_0, [(-8) * 1e-15, ...
%                                                         (-287)*(1e-15)^2, ...
%                                                         (-236)*(1e-15)^3 ...
%                                                         (-200)*(1e-15)^4]);
%     [t, E]              = chirperPlate(t, E, lambda_list, spectral_phase, dispersion);
%     [t, E]              = quarterWP_PAC(t, E, angle_QWP, qwpType, dispersion);
%     [t, E]              = halfWP_PAC(t, E, angle_HWP, hwpType, dispersion);
%     [t, E]              = chirperPlate(t, E, lambda_list, data_UVFS.spectral_phase_value * thickness_window, dispersion); % Beamline window
%     [t, E]              = arbitraryWP_PAC(t, E, angle_parasitic_WP, retardance_parasitic_WP);
%     [t, E]              = removeGDOffset(t, E, lambda_list, lambda_0, dispersion);
%     dispersion_values                           = getDispersionValuesFromEField(t, E(1, :), lambda_0, 3, true);
%     [ellipticity, ExHull, EyHull, orientation]  = ellipticity_finder(t, E, 0, time_window);
%     Ex                                          = real(E(1, :));
%     Ey                                          = real(E(2, :));
%     [time_max_Ex, time_max_Ey, maxEx, maxEy, ellipticity_Ex, orientation_Ex, ellipticity_Ey, orientation_Ey] = findPeakElectricField(t, E, time_window);
%     
%     disp(['Overall ellipticity....... ', num2str(ellipticity)])
%     disp(['Orientation (degrees)..... ', num2str(orientation)])
%     disp(' ')
%     disp('............. E field x .............')
%     disp(['   Max field ............. ', num2str(maxEx)])
%     disp(['   Time max field......... ', num2str(time_max_Ex*1e15), ' fs'])
%     disp(['   Ellipticity max field.. ', num2str(ellipticity_Ex)])
%     disp(['   Orientation max field.. ', num2str(orientation_Ex)])
%     disp(['   Pulse duration......... ', num2str(FWHM(t, abs(E(1, :)).^2) * 1e15), ' fs'])
%     disp(' ')
%     disp('............. E field y .............')
%     disp(['   Max field ............. ', num2str(maxEy)])
%     disp(['   Time max field......... ', num2str(time_max_Ey*1e15), ' fs'])
%     disp(['   Ellipticity max field.. ', num2str(ellipticity_Ey)])
%     disp(['   Orientation max field.. ', num2str(orientation_Ey)])
%     disp(['   Pulse duration......... ', num2str(FWHM(t, abs(E(2, :)).^2) * 1e15), ' fs'])
%     
%     subplot 221
%     plot(t * 1e15, Ex)
%     xlabel('Time (fs)')
%     ylabel('E field (o axis)')
%     grid on
%     ylim([-1 1])
%     subplot 222
%     plot(t * 1e15, Ey)
%     xlabel('Time (fs)')
%     ylabel('E field (e axis)')
%     grid on
%     ylim([-1 1])
%     subplot 223
%     plot(Ex, Ey)
%     hold on
%     plot(ExHull, EyHull, 'b--')
%     hold off
%     xlabel('Time (fs)')
%     xlabel('E field (o axis)')
%     ylabel('E field (e axis)')
%     grid on
%     xlim([-1 1])
%     ylim([-1 1])
%     axis square
%     subplot 224
%     plot3(t * 1e15, Ex, Ey);
%     xlabel('Time (fs)')
%     ylabel('E field (o axis)')
%     zlabel('E field (e axis)')
%     ylim([-1 1])
%     zlim([-1 1])
%     view(3)
%     grid on
%     drawnow
%     makeItNice('FullScreen', false)
%     sgtitle(['Simulation for ', hwpType, ' and ', qwpType, ' waveplates'], 'fontsize', 25, 'interpreter', 'none')
%
% Date: 04.02.2022
%
% Author: Pierre-Alexis Chevreuil (chpierre@phys.ethz.ch), based on a code
% from Fabian Brunner (F)

c               = 299792458;
rotField        = [cos(alpha), -sin(alpha); sin(alpha), cos(alpha)];
rotFieldBack    = [cos(-alpha), -sin(-alpha); sin(-alpha), cos(-alpha)];
E_rot           = rotField * E_in;
L               = size(E_rot, 2);
timeStep        = t_in(2) - t_in(1);
timePd          = timeStep * (0 : L-1) + t_in(1);
timeSpan        = timePd(end) - timePd(1);
freq            = (-L/2:L/2-1) / timeSpan;
E_freq          = (fftshift(fft(E_rot, [], 2), 2));
phaseShiftHWP_o = zeros(size(t_in)); % For compiler ...
phaseShiftHWP_e = zeros(size(t_in)); % For compiler ...

switch hwpType
    case 'ideal' % ideal wave plate
        phaseShiftHWP   = ones(size(freq)) * pi;
        axisHWP         = ones(size(freq)) * 0;

    case 'RAC5_2'
        axisHWP                 = ones(size(freq))*0; % data not available
        thickness_quartz        = 1.273e-3;
        thickness_MgF2          = 1.005e-3;
        lambda_list_for_Sellm   = 400e-9 : 1e-9 : 1400e-9;
        A_Q_o                   = 1.28604141;
        B_Q_o                   = 1.07044083;
        C_Q_o                   = 1.00585997e-2;
        D_Q_o                   = 1.10202242;
        F_Q_o                   = 100;
        n_fun_Q_o               = @(lambda) sqrt(A_Q_o + ...
                                                     B_Q_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - C_Q_o) + ...
                                                     D_Q_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - F_Q_o));
        spectralPhaseQuartzO    = 2 * pi * n_fun_Q_o(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_quartz;
        A_Q_e                   = 1.28851804;
        B_Q_e                   = 1.09509924;
        C_Q_e                   = 1.02101864e-2;
        D_Q_e                   = 1.15662475;
        F_Q_e                   = 100;
        n_fun_Q_e               = @(lambda) sqrt(A_Q_e + ...
                                                 B_Q_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - C_Q_e) + ...
                                                 D_Q_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - F_Q_e));
        spectralPhaseQuartzE    = 2 * pi * n_fun_Q_e(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_quartz;
        A1_M_o                  = 0.48755108;
        A2_M_o                  = 0.39875031;
        A3_M_o                  = 2.3120353;
        L1_M_o                  = 0.04338408;
        L2_M_o                  = 0.09461442;
        L3_M_o                  = 23.793604;
        n_fun_M_o               = @(lambda) sqrt(1 + ...
                                                 A1_M_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L1_M_o^2) + ...
                                                 A2_M_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L2_M_o^2) + ...
                                                 A3_M_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L3_M_o^2));
        spectralPhaseMgF2O      = 2 * pi * n_fun_M_o(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_MgF2;
        A1_M_e                  = 0.41344023;
        A2_M_e                  = 0.50497499;
        A3_M_e                  = 2.4904862;
        L1_M_e                  = 0.03684262;
        L2_M_e                  = 0.09076162;
        L3_M_e                  = 23.771995;
        n_fun_M_e               = @(lambda) sqrt(1 + ...
                                                 A1_M_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L1_M_e^2) + ...
                                                 A2_M_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L2_M_e^2) + ...
                                                 A3_M_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L3_M_e^2));
        spectralPhaseMgF2E      = 2 * pi * n_fun_M_e(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_MgF2;
        phaseShiftHWP_o         = spectralPhaseMgF2E + spectralPhaseQuartzO;
        phaseShiftHWP_e         = spectralPhaseMgF2O + spectralPhaseQuartzE;
        phaseShiftHWP_o         = interp1(lambda_list_for_Sellm, phaseShiftHWP_o, c ./ freq, 'linear', 'extrap');
        phaseShiftHWP_e         = interp1(lambda_list_for_Sellm, phaseShiftHWP_e, c ./ freq, 'linear', 'extrap');
        phaseShiftHWP           = phaseShiftHWP_o - phaseShiftHWP_e; % In case we don't go for dispersion
        
    case 'RSU2_2' % LOAD QWP SPECS: (wavelength [µm], retardation [lambda], angle axis[rad])
        HWPspecs = [
        0.5    0.43691    -6.9379; ...
        0.505    0.44831    -6.209; ...
        0.51    0.45797    -5.514; ...
        0.515    0.46609    -4.8584; ...
        0.52    0.47287    -4.2461; ...
        0.525    0.47849    -3.6794; ...
        0.53    0.48311    -3.1596; ...
        0.535    0.48689    -2.6868; ...
        0.54    0.48994    -2.2599; ...
        0.545    0.4924    -1.8775; ...
        0.55    0.49434    -1.5375; ...
        0.555    0.49588    -1.2372; ...
        0.56    0.49707    -0.97392; ...
        0.565    0.49799    -0.74481; ...
        0.57    0.49868    -0.54694; ...
        0.575    0.49919    -0.37743; ...
        0.58    0.49956    -0.23349; ...
        0.585    0.49981    -0.11249; ...
        0.59    0.49998    -0.011917; ...
        0.595    0.50009    0.070547; ...
        0.6    0.50014    0.13705; ...
        0.605    0.50016    0.18955; ...
        0.61    0.50016    0.22985; ...
        0.615    0.50013    0.25956; ...
        0.62    0.5001    0.28015; ...
        0.625    0.50006    0.29293; ...
        0.63    0.50002    0.29907; ...
        0.635    0.49998    0.2996; ...
        0.64    0.49995    0.29547; ...
        0.645    0.49992    0.28747; ...
        0.65    0.49989    0.27632; ...
        0.655    0.49987    0.26267; ...
        0.66    0.49985    0.24705; ...
        0.665    0.49984    0.22995; ...
        0.67    0.49984    0.21178; ...
        0.675    0.49984    0.19291; ...
        0.68    0.49984    0.17363; ...
        0.685    0.49985    0.15422; ...
        0.69    0.49986    0.1349; ...
        0.695    0.49987    0.11586; ...
        0.7    0.49989    0.097258; ...
        0.705    0.4999    0.079225; ...
        0.71    0.49992    0.06187; ...
        0.715    0.49994    0.045279; ...
        0.72    0.49996    0.029521; ...
        0.725    0.49998    0.014649; ...
        0.73    0.5    0.00070186; ...
        0.735    0.50002    -0.012294; ...
        0.74    0.50004    -0.024322; ...
        0.745    0.50005    -0.035375; ...
        0.75    0.50007    -0.045452; ...
        0.755    0.50008    -0.05456; ...
        0.76    0.5001    -0.062712; ...
        0.765    0.50011    -0.069925; ...
        0.77    0.50012    -0.076219; ...
        0.775    0.50013    -0.081619; ...
        0.78    0.50014    -0.086151; ...
        0.785    0.50015    -0.089843; ...
        0.79    0.50015    -0.092728; ...
        0.795    0.50015    -0.094836; ...
        0.8    0.50016    -0.096199; ...
        0.805    0.50016    -0.096853; ...
        0.81    0.50016    -0.096829; ...
        0.815    0.50016    -0.096163; ...
        0.82    0.50015    -0.094887; ...
        0.825    0.50015    -0.093035; ...
        0.83    0.50015    -0.090642; ...
        0.835    0.50014    -0.087738; ...
        0.84    0.50014    -0.084357; ...
        0.845    0.50013    -0.08053; ...
        0.85    0.50012    -0.076287; ...
        0.855    0.50011    -0.071659; ...
        0.86    0.5001    -0.066675; ...
        0.865    0.5001    -0.061363; ...
        0.87    0.50009    -0.05575; ...
        0.875    0.50008    -0.049862; ...
        0.88    0.50007    -0.043725; ...
        0.885    0.50006    -0.037363; ...
        0.89    0.50005    -0.030801; ...
        0.895    0.50004    -0.024059; ...
        0.9    0.50002    -0.017161; ...
        0.905    0.50001    -0.010126; ...
        0.91    0.5    -0.0029746; ...
        0.915    0.49999    0.0042747; ...
        0.92    0.49998    0.011604; ...
        0.925    0.49997    0.018996; ...
        0.93    0.49996    0.026434; ...
        0.935    0.49995    0.033904; ...
        0.94    0.49995    0.041391; ...
        0.945    0.49994    0.048881; ...
        0.95    0.49993    0.056361; ...
        0.955    0.49992    0.063819; ...
        0.96    0.49991    0.071244; ...
        0.965    0.4999    0.078624; ...
        0.97    0.4999    0.085949; ...
        0.975    0.49989    0.093211; ...
        0.98    0.49988    0.1004; ...
        0.985    0.49988    0.10751; ...
        0.99    0.49987    0.11453; ...
        0.995    0.49987    0.12145; ...
        1    0.49986    0.12828; ...
        1.005    0.49986    0.13499; ...
        1.01    0.49986    0.14159; ...
        1.015    0.49985    0.14807; ...
        1.02    0.49985    0.15443; ...
        1.025    0.49985    0.16066; ...
        1.03    0.49984    0.16677; ...
        1.035    0.49984    0.17273; ...
        1.04    0.49984    0.17857; ...
        1.045    0.49984    0.18426; ...
        1.05    0.49984    0.18981; ...
        1.055    0.49984    0.19521; ...
        1.06    0.49984    0.20047; ...
        1.065    0.49984    0.20559; ...
        1.07    0.49984    0.21056; ...
        1.075    0.49984    0.21538; ...
        1.08    0.49984    0.22005; ...
        1.085    0.49984    0.22457; ...
        1.09    0.49984    0.22895; ...
        1.095    0.49985    0.23318; ...
        1.1    0.49985    0.23726; ...
        1.105    0.49985    0.24119; ...
        1.11    0.49985    0.24498; ...
        1.115    0.49986    0.24862; ...
        1.12    0.49986    0.25211; ...
        1.125    0.49986    0.25547; ...
        1.13    0.49987    0.25868; ...
        1.135    0.49987    0.26175; ...
        1.14    0.49987    0.26469; ...
        1.145    0.49988    0.26749; ...
        1.15    0.49988    0.27015; ...
        1.155    0.49988    0.27269; ...
        1.16    0.49989    0.27509; ...
        1.165    0.49989    0.27736; ...
        1.17    0.4999    0.27951; ...
        1.175    0.4999    0.28154; ...
        1.18    0.49991    0.28344; ...
        1.185    0.49991    0.28522; ...
        1.19    0.49992    0.28689; ...
        1.195    0.49992    0.28845; ...
        1.2    0.49993    0.28989; ...
        1.205    0.49993    0.29123; ...
        1.21    0.49993    0.29245; ...
        1.215    0.49994    0.29358; ...
        1.22    0.49994    0.2946; ...
        1.225    0.49995    0.29553; ...
        1.23    0.49995    0.29636; ...
        1.235    0.49996    0.2971; ...
        1.24    0.49996    0.29775; ...
        1.245    0.49997    0.29831; ...
        1.25    0.49997    0.29878; ...
        1.255    0.49998    0.29917; ...
        1.26    0.49998    0.29949; ...
        1.265    0.49999    0.29972; ...
        1.27    0.49999    0.29989; ...
        1.275    0.5    0.29998; ...
        1.28    0.5    0.3; ...
        1.285    0.50001    0.29995; ...
        1.29    0.50001    0.29985; ...
        1.295    0.50001    0.29968; ...
        1.3    0.50002    0.29945; ...
        1.305    0.50002    0.29916; ...
        1.31    0.50003    0.29883; ...
        1.315    0.50003    0.29844; ...
        1.32    0.50003    0.298; ...
        1.325    0.50004    0.29751; ...
        1.33    0.50004    0.29698; ...
        1.335    0.50005    0.29641; ...
        1.34    0.50005    0.2958; ...
        1.345    0.50005    0.29515; ...
        1.35    0.50006    0.29447; ...
        1.355    0.50006    0.29375; ...
        1.36    0.50006    0.293; ...
        1.365    0.50007    0.29222; ...
        1.37    0.50007    0.29142; ...
        1.375    0.50007    0.29059; ...
        1.38    0.50008    0.28974; ...
        1.385    0.50008    0.28887; ...
        1.39    0.50008    0.28798; ...
        1.395    0.50008    0.28707; ...
        1.4    0.50009    0.28614; ...
        1.405    0.50009    0.28521; ...
        1.41    0.50009    0.28426; ...
        1.415    0.50009    0.2833; ...
        1.42    0.5001    0.28233; ...
        1.425    0.5001    0.28135; ...
        1.43    0.5001    0.28037; ...
        1.435    0.5001    0.27938; ...
        1.44    0.5001    0.2784; ...
        1.445    0.50011    0.27741; ...
        1.45    0.50011    0.27642; ...
        1.455    0.50011    0.27543; ...
        1.46    0.50011    0.27445; ...
        1.465    0.50011    0.27347; ...
        1.47    0.50012    0.2725; ...
        1.475    0.50012    0.27153; ...
        1.48    0.50012    0.27057; ...
        1.485    0.50012    0.26963; ...
        1.49    0.50012    0.26869; ...
        1.495    0.50012    0.26776; ...
        1.5    0.50012    0.26684; ...
        1.505    0.50013    0.26594; ...
        1.51    0.50013    0.26505; ...
        1.515    0.50013    0.26418; ...
        1.52    0.50013    0.26332; ...
        1.525    0.50013    0.26248; ...
        1.53    0.50013    0.26166; ...
        1.535    0.50013    0.26085; ...
        1.54    0.50013    0.26007; ...
        1.545    0.50013    0.2593; ...
        1.55    0.50013    0.25856; ...
        1.555    0.50014    0.25783; ...
        1.56    0.50014    0.25713; ...
        1.565    0.50014    0.25645; ...
        1.57    0.50014    0.25579; ...
        1.575    0.50014    0.25516; ...
        1.58    0.50014    0.25455; ...
        1.585    0.50014    0.25396; ...
        1.59    0.50014    0.2534; ...
        1.595    0.50014    0.25286; ...
        1.6    0.50014    0.25235; ...
        1.605    0.50014    0.25186; ...
        1.61    0.50014    0.2514; ...
        1.615    0.50014    0.25097; ...
        1.62    0.50014    0.25056; ...
        1.625    0.50014    0.25018; ...
        1.63    0.50014    0.24982; ...
        1.635    0.50014    0.24949; ...
        1.64    0.50014    0.24919; ...
        1.645    0.50014    0.24892; ...
        1.65    0.50014    0.24867; ...
        1.655    0.50014    0.24845; ...
        1.66    0.50014    0.24826; ...
        1.665    0.50014    0.24809; ...
        1.67    0.50015    0.24795; ...
        1.675    0.50015    0.24784; ...
        1.68    0.50015    0.24776; ...
        1.685    0.50015    0.2477; ...
        1.69    0.50015    0.24767; ...
        1.695    0.50015    0.24766; ...
        1.7    0.50015    0.24768; ...
        1.705    0.50015    0.24773; ...
        1.71    0.50015    0.24781; ...
        1.715    0.50015    0.24791; ...
        1.72    0.50014    0.24803; ...
        1.725    0.50014    0.24818; ...
        1.73    0.50014    0.24836; ...
        1.735    0.50014    0.24856; ...
        1.74    0.50014    0.24879; ...
        1.745    0.50014    0.24904; ...
        1.75    0.50014    0.24931; ...
        1.755    0.50014    0.24961; ...
        1.76    0.50014    0.24993; ...
        1.765    0.50014    0.25027; ...
        1.77    0.50014    0.25063; ...
        1.775    0.50014    0.25102; ...
        1.78    0.50014    0.25143; ...
        1.785    0.50014    0.25186; ...
        1.79    0.50014    0.25231; ...
        1.795    0.50014    0.25278; ...
        1.8    0.50014    0.25327; ...
        1.805    0.50014    0.25378; ...
        1.81    0.50014    0.2543; ...
        1.815    0.50014    0.25485; ...
        1.82    0.50014    0.25541; ...
        1.825    0.50014    0.25599; ...
        1.83    0.50014    0.25658; ...
        1.835    0.50014    0.25719; ...
        1.84    0.50014    0.25782; ...
        1.845    0.50014    0.25846; ...
        1.85    0.50013    0.25912; ...
        1.855    0.50013    0.25978; ...
        1.86    0.50013    0.26046; ...
        1.865    0.50013    0.26116; ...
        1.87    0.50013    0.26186; ...
        1.875    0.50013    0.26258; ...
        1.88    0.50013    0.2633; ...
        1.885    0.50013    0.26404; ...
        1.89    0.50013    0.26478; ...
        1.895    0.50013    0.26553; ...
        1.9    0.50013    0.26629; ...
        1.905    0.50012    0.26706; ...
        1.91    0.50012    0.26783; ...
        1.915    0.50012    0.26861; ...
        1.92    0.50012    0.26939; ...
        1.925    0.50012    0.27018; ...
        1.93    0.50012    0.27097; ...
        1.935    0.50012    0.27176; ...
        1.94    0.50012    0.27255; ...
        1.945    0.50011    0.27335; ...
        1.95    0.50011    0.27415; ...
        1.955    0.50011    0.27494; ...
        1.96    0.50011    0.27574; ...
        1.965    0.50011    0.27653; ...
        1.97    0.50011    0.27732; ...
        1.975    0.50011    0.27811; ...
        1.98    0.5001    0.2789; ...
        1.985    0.5001    0.27968; ...
        1.99    0.5001    0.28046; ...
        1.995    0.5001    0.28123; ...
        2    0.5001    0.28199; ...
        2.005    0.5001    0.28275; ...
        2.01    0.50009    0.28349; ...
        2.015    0.50009    0.28423; ...
        2.02    0.50009    0.28497; ...
        2.025    0.50009    0.28569; ...
        2.03    0.50009    0.2864; ...
        2.035    0.50008    0.2871; ...
        2.04    0.50008    0.28778; ...
        2.045    0.50008    0.28846; ...
        2.05    0.50008    0.28912; ...
        2.055    0.50008    0.28977; ...
        2.06    0.50007    0.2904; ...
        2.065    0.50007    0.29102; ...
        2.07    0.50007    0.29162; ...
        2.075    0.50007    0.29221; ...
        2.08    0.50006    0.29278; ...
        2.085    0.50006    0.29333; ...
        2.09    0.50006    0.29386; ...
        2.095    0.50006    0.29438; ...
        2.1    0.50005    0.29487; ...
        2.105    0.50005    0.29535; ...
        2.11    0.50005    0.29581; ...
        2.115    0.50005    0.29624; ...
        2.12    0.50004    0.29665; ...
        2.125    0.50004    0.29705; ...
        2.13    0.50004    0.29741; ...
        2.135    0.50004    0.29776; ...
        2.14    0.50003    0.29808; ...
        2.145    0.50003    0.29838; ...
        2.15    0.50003    0.29866; ...
        2.155    0.50003    0.29891; ...
        2.16    0.50002    0.29914; ...
        2.165    0.50002    0.29934; ...
        2.17    0.50002    0.29951; ...
        2.175    0.50001    0.29966; ...
        2.18    0.50001    0.29978; ...
        2.185    0.50001    0.29988; ...
        2.19    0.50001    0.29995; ...
        2.195    0.5    0.29999; ...
        2.2    0.5    0.3; ...
        2.205    0.5    0.29999; ...
        2.21    0.49999    0.29994; ...
        2.215    0.49999    0.29987; ...
        2.22    0.49999    0.29978; ...
        2.225    0.49999    0.29965; ...
        2.23    0.49998    0.29949; ...
        2.235    0.49998    0.29931; ...
        2.24    0.49998    0.29909; ...
        2.245    0.49997    0.29885; ...
        2.25    0.49997    0.29858; ...
        2.255    0.49997    0.29828; ...
        2.26    0.49997    0.29795; ...
        2.265    0.49996    0.2976; ...
        2.27    0.49996    0.29721; ...
        2.275    0.49996    0.29679; ...
        2.28    0.49995    0.29635; ...
        2.285    0.49995    0.29588; ...
        2.29    0.49995    0.29538; ...
        2.295    0.49995    0.29485; ...
        2.3    0.49994    0.29429; ...
        2.305    0.49994    0.29371; ...
        2.31    0.49994    0.2931; ...
        2.315    0.49993    0.29246; ...
        2.32    0.49993    0.29179; ...
        2.325    0.49993    0.2911; ...
        2.33    0.49993    0.29038; ...
        2.335    0.49992    0.28964; ...
        2.34    0.49992    0.28887; ...
        2.345    0.49992    0.28808; ...
        2.35    0.49992    0.28726; ...
        2.355    0.49991    0.28642; ...
        2.36    0.49991    0.28556; ...
        2.365    0.49991    0.28468; ...
        2.37    0.49991    0.28377; ...
        2.375    0.49991    0.28284; ...
        2.38    0.4999    0.28189; ...
        2.385    0.4999    0.28093; ...
        2.39    0.4999    0.27994; ...
        2.395    0.4999    0.27894; ...
        2.4    0.49989    0.27792; ...
        2.405    0.49989    0.27688; ...
        2.41    0.49989    0.27583; ...
        2.415    0.49989    0.27476; ...
        2.42    0.49989    0.27368; ...
        2.425    0.49988    0.27258; ...
        2.43    0.49988    0.27148; ...
        2.435    0.49988    0.27037; ...
        2.44    0.49988    0.26924; ...
        2.445    0.49988    0.26811; ...
        2.45    0.49988    0.26697; ...
        2.455    0.49987    0.26583; ...
        2.46    0.49987    0.26468; ...
        2.465    0.49987    0.26352; ...
        2.47    0.49987    0.26237; ...
        2.475    0.49987    0.26121; ...
        2.48    0.49987    0.26006; ...
        2.485    0.49987    0.25891; ...
        2.49    0.49986    0.25776; ...
        2.495    0.49986    0.25661; ...
        2.5    0.49986    0.25548; ...
        2.505    0.49986    0.25435; ...
        2.51    0.49986    0.25323; ...
        2.515    0.49986    0.25212; ...
        2.52    0.49986    0.25102; ...
        2.525    0.49986    0.24994; ...
        2.53    0.49986    0.24887; ...
        2.535    0.49985    0.24782; ...
        2.54    0.49985    0.24679; ...
        2.545    0.49985    0.24578; ...
        2.55    0.49985    0.24479; ...
        2.555    0.49985    0.24382; ...
        2.56    0.49985    0.24288; ...
        2.565    0.49985    0.24197; ...
        2.57    0.49985    0.24109; ...
        2.575    0.49985    0.24024; ...
        2.58    0.49985    0.23942; ...
        2.585    0.49985    0.23864; ...
        2.59    0.49985    0.23789; ...
        2.595    0.49985    0.23718; ...
        2.6    0.49985    0.2365; ...
        2.605    0.49985    0.23588; ...
        2.61    0.49985    0.23529; ...
        2.615    0.49985    0.23475; ...
        2.62    0.49985    0.23425; ...
        2.625    0.49985    0.2338; ...
        2.63    0.49985    0.23341; ...
        2.635    0.49985    0.23306; ...
        2.64    0.49985    0.23277; ...
        2.645    0.49985    0.23253; ...
        2.65    0.49984    0.23235; ...
        2.655    0.49984    0.23222; ...
        2.66    0.49984    0.23216; ...
        2.665    0.49984    0.23215; ...
        2.67    0.49984    0.23221; ...
        2.675    0.49984    0.23233; ...
        2.68    0.49985    0.23252; ...
        2.685    0.49985    0.23277; ...
        2.69    0.49985    0.23308; ...
        2.695    0.49985    0.23347; ...
        2.7    0.49985    0.23392; ...
        2.705    0.49985    0.23444; ...
        2.71    0.49985    0.23504; ...
        2.715    0.49985    0.2357; ...
        2.72    0.49985    0.23643; ...
        2.725    0.49985    0.23724; ...
        2.73    0.49985    0.23811; ...
        2.735    0.49985    0.23906; ...
        2.74    0.49985    0.24007; ...
        2.745    0.49985    0.24116; ...
        2.75    0.49985    0.24232; ...
        2.755    0.49985    0.24355; ...
        2.76    0.49985    0.24484; ...
        2.765    0.49985    0.2462; ...
        2.77    0.49985    0.24763; ...
        2.775    0.49986    0.24912; ...
        2.78    0.49986    0.25067; ...
        2.785    0.49986    0.25229; ...
        2.79    0.49986    0.25396; ...
        2.795    0.49986    0.25568];
        HWPspecs(:,1)   = c ./ (HWPspecs(:,1).*1e-6);      % convert to frequency
        HWPspecs(:,3)   = HWPspecs(:,3) * pi/180;         % axis data are in degrees!!! rad required
        axisHWP         = interp1(HWPspecs(:,1), HWPspecs(:,3), freq, 'linear',0);
        phaseShiftHWP   = interp1(HWPspecs(:,1), HWPspecs(:,2), freq, 'linear','extrap')*pi*2;
            
    case 'RSU1_2' % LOAD QWP SPECS: (wavelength [µm], retardation [lambda], angle axis[rad])
        HWPspecs = [
        0.28    0.2656    -11.74; ...
        0.285    0.3391    -10.03; ...
        0.29    0.3971    -8.012; ...
        0.295    0.4403    -5.824; ...
        0.3    0.4704    -3.643; ...
        0.305    0.4896    -1.634; ...
        0.31    0.5004    0.07712; ...
        0.315    0.5052    1.423; ...
        0.32    0.5061    2.394; ...
        0.325    0.5048    3.02; ...
        0.33    0.5025    3.352; ...
        0.335    0.5    3.45; ...
        0.34    0.4977    3.37; ...
        0.345    0.4959    3.164; ...
        0.35    0.4947    2.874; ...
        0.355    0.494    2.533; ...
        0.36    0.4939    2.167; ...
        0.365    0.4942    1.795; ...
        0.37    0.4948    1.43; ...
        0.375    0.4957    1.082; ...
        0.38    0.4968    0.757; ...
        0.385    0.4979    0.4586; ...
        0.39    0.4991    0.1887; ...
        0.395    0.5003    -0.05214; ...
        0.4    0.5014    -0.2641; ...
        0.405    0.5024    -0.4481; ...
        0.41    0.5033    -0.6051; ...
        0.415    0.5041    -0.7366; ...
        0.42    0.5048    -0.8442; ...
        0.425    0.5054    -0.9294; ...
        0.43    0.5058    -0.9936; ...
        0.435    0.5061    -1.039; ...
        0.44    0.5063    -1.066; ...
        0.445    0.5063    -1.076; ...
        0.45    0.5063    -1.072; ...
        0.455    0.5062    -1.053; ...
        0.46    0.506    -1.022; ...
        0.465    0.5057    -0.9793; ...
        0.47    0.5053    -0.9259; ...
        0.475    0.5049    -0.863; ...
        0.48    0.5045    -0.7914; ...
        0.485    0.504    -0.7121; ...
        0.49    0.5034    -0.6258; ...
        0.495    0.5029    -0.5332; ...
        0.5    0.5023    -0.4352; ...
        0.505    0.5017    -0.3324; ...
        0.51    0.5012    -0.2254; ...
        0.515    0.5006    -0.1148; ...
        0.52    0.5    -0.001249; ...
        0.525    0.4994    0.1148; ...
        0.53    0.4989    0.2327; ...
        0.535    0.4984    0.3521; ...
        0.54    0.4979    0.4726; ...
        0.545    0.4974    0.5936; ...
        0.55    0.4969    0.7149; ...
        0.555    0.4965    0.8359; ...
        0.56    0.4961    0.9565; ...
        0.565    0.4957    1.076; ...
        0.57    0.4954    1.195; ...
        0.575    0.4951    1.312; ...
        0.58    0.4948    1.427; ...
        0.585    0.4946    1.541; ...
        0.59    0.4944    1.652; ...
        0.595    0.4942    1.761; ...
        0.6    0.4941    1.867; ...
        0.605    0.494    1.971; ...
        0.61    0.4939    2.071; ...
        0.615    0.4939    2.169; ...
        0.62    0.4939    2.263; ...
        0.625    0.4939    2.354; ...
        0.63    0.4939    2.442; ...
        0.635    0.494    2.526; ...
        0.64    0.4941    2.607; ...
        0.645    0.4942    2.684; ...
        0.65    0.4944    2.757; ...
        0.655    0.4945    2.827; ...
        0.66    0.4947    2.893; ...
        0.665    0.4949    2.955; ...
        0.67    0.4951    3.013; ...
        0.675    0.4954    3.068; ...
        0.68    0.4956    3.119; ...
        0.685    0.4959    3.166; ...
        0.69    0.4962    3.209; ...
        0.695    0.4965    3.249; ...
        0.7    0.4968    3.285; ...
        0.705    0.4971    3.317; ...
        0.71    0.4974    3.345; ...
        0.715    0.4977    3.37; ...
        0.72    0.498    3.392; ...
        0.725    0.4984    3.41; ...
        0.73    0.4987    3.425; ...
        0.735    0.499    3.436; ...
        0.74    0.4993    3.444; ...
        0.745    0.4997    3.448; ...
        0.75    0.5    3.45; ...
        0.755    0.5003    3.448; ...
        0.76    0.5006    3.444; ...
        0.765    0.501    3.436; ...
        0.77    0.5013    3.426; ...
        0.775    0.5016    3.413; ...
        0.78    0.5019    3.397; ...
        0.785    0.5022    3.378; ...
        0.79    0.5025    3.357; ...
        0.795    0.5028    3.333; ...
        0.8    0.503    3.307; ...
        0.805    0.5033    3.279; ...
        0.81    0.5035    3.248; ...
        0.815    0.5038    3.215; ...
        0.82    0.504    3.18; ...
        0.825    0.5042    3.143; ...
        0.83    0.5044    3.104; ...
        0.835    0.5046    3.063; ...
        0.84    0.5048    3.02; ...
        0.845    0.505    2.975; ...
        0.85    0.5052    2.929; ...
        0.855    0.5053    2.881; ...
        0.86    0.5055    2.832; ...
        0.865    0.5056    2.781; ...
        0.87    0.5057    2.728; ...
        0.875    0.5058    2.674; ...
        0.88    0.5059    2.619; ...
        0.885    0.506    2.563; ...
        0.89    0.506    2.505; ...
        0.895    0.5061    2.447; ...
        0.9    0.5061    2.387; ...
        0.905    0.5061    2.326; ...
        0.91    0.5061    2.264; ...
        0.915    0.5061    2.202; ...
        0.92    0.5061    2.138; ...
        0.925    0.5061    2.074; ...
        0.93    0.5061    2.009; ...
        0.935    0.506    1.943; ...
        0.94    0.5059    1.877; ...
        0.945    0.5059    1.81; ...
        0.95    0.5058    1.742; ...
        0.955    0.5057    1.674; ...
        0.96    0.5055    1.606; ...
        0.965    0.5054    1.537; ...
        0.97    0.5053    1.467; ...
        0.975    0.5051    1.398; ...
        0.98    0.505    1.327; ...
        0.985    0.5048    1.257; ...
        0.99    0.5046    1.186; ...
        0.995    0.5044    1.115; ...
        1    0.5042    1.044; ...
        1.005    0.504    0.9731; ...
        1.01    0.5037    0.9017; ...
        1.015    0.5035    0.8302; ...
        1.02    0.5032    0.7587; ...
        1.025    0.503    0.687; ...
        1.03    0.5027    0.6154; ...
        1.035    0.5024    0.5437; ...
        1.04    0.5021    0.4721; ...
        1.045    0.5018    0.4005; ...
        1.05    0.5015    0.3289; ...
        1.055    0.5012    0.2575; ...
        1.06    0.5009    0.1861; ...
        1.065    0.5006    0.1149; ...
        1.07    0.5002    0.04385; ...
        1.075    0.4999    -0.02707; ...
        1.08    0.4995    -0.09781; ...
        1.085    0.4991    -0.1684; ...
        1.09    0.4988    -0.2387; ...
        1.095    0.4984    -0.3088; ...
        1.1    0.498    -0.3787; ...
        1.105    0.4976    -0.4483; ...
        1.11    0.4972    -0.5177; ...
        1.115    0.4968    -0.5868; ...
        1.12    0.4964    -0.6556; ...
        1.125    0.496    -0.7241; ...
        1.13    0.4955    -0.7923; ...
        1.135    0.4951    -0.8601; ...
        1.14    0.4947    -0.9277; ...
        1.145    0.4942    -0.9949; ...
        1.15    0.4938    -1.062; ...
        1.155    0.4933    -1.128; ...
        1.16    0.4929    -1.194; ...
        1.165    0.4924    -1.26; ...
        1.17    0.4919    -1.326; ...
        1.175    0.4914    -1.391; ...
        1.18    0.491    -1.455; ...
        1.185    0.4905    -1.52; ...
        1.19    0.49    -1.584; ...
        1.195    0.4895    -1.647; ...
        1.2    0.489    -1.71; ...
        1.205    0.4885    -1.773; ...
        1.21    0.488    -1.835; ...
        1.215    0.4875    -1.897; ...
        1.22    0.487    -1.958; ...
        1.225    0.4865    -2.019; ...
        1.23    0.486    -2.08; ...
        1.235    0.4855    -2.14; ...
        1.24    0.4849    -2.2; ...
        1.245    0.4844    -2.259; ...
        1.25    0.4839    -2.318; ...
        1.255    0.4834    -2.377; ...
        1.26    0.4828    -2.435; ...
        1.265    0.4823    -2.492; ...
        1.27    0.4818    -2.55; ...
        1.275    0.4812    -2.606; ...
        1.28    0.4807    -2.663; ...
        1.285    0.4802    -2.718; ...
        1.29    0.4796    -2.774; ...
        1.295    0.4791    -2.829; ...
        1.3    0.4785    -2.884; ...
        1.305    0.478    -2.938; ...
        1.31    0.4775    -2.992; ...
        1.315    0.4769    -3.045; ...
        1.32    0.4764    -3.098; ...
        1.325    0.4758    -3.15; ...
        1.33    0.4753    -3.202; ...
        1.335    0.4747    -3.254; ...
        1.34    0.4742    -3.305; ...
        1.345    0.4736    -3.356; ...
        1.35    0.4731    -3.406; ...
        1.355    0.4725    -3.456; ...
        1.36    0.472    -3.506; ...
        1.365    0.4714    -3.555; ...
        1.37    0.4709    -3.603; ...
        1.375    0.4703    -3.652; ...
        1.38    0.4698    -3.7; ...
        1.385    0.4692    -3.747; ...
        1.39    0.4687    -3.794; ...
        1.395    0.4681    -3.841; ...
        1.4    0.4676    -3.887; ...
        1.405    0.467    -3.933; ...
        1.41    0.4665    -3.978; ...
        1.415    0.4659    -4.024; ...
        1.42    0.4654    -4.068; ...
        1.425    0.4648    -4.113; ...
        1.43    0.4643    -4.156; ...
        1.435    0.4637    -4.2; ...
        1.44    0.4632    -4.243; ...
        1.445    0.4626    -4.286; ...
        1.45    0.4621    -4.328; ...
        1.455    0.4616    -4.37; ...
        1.46    0.461    -4.412; ...
        1.465    0.4605    -4.453; ...
        1.47    0.4599    -4.494; ...
        1.475    0.4594    -4.535; ...
        1.48    0.4589    -4.575; ...
        1.485    0.4583    -4.615; ...
        1.49    0.4578    -4.654; ...
        1.495    0.4573    -4.694];
        HWPspecs(:,1)   = c ./ (HWPspecs(:,1).*1e-6);      % convert to frequency
        HWPspecs(:,3)   = HWPspecs(:,3) * pi/180;         % axis data are in degrees!!! rad required
        axisHWP         = interp1(HWPspecs(:,1), HWPspecs(:,3), freq, 'linear',0);
        phaseShiftHWP   = interp1(HWPspecs(:,1), HWPspecs(:,2), freq, 'linear','extrap')*pi*2;
        
    otherwise
        error('Waveplate %s not supported', hwpType);
end

E_trans = complex(zeros(size(E_freq)));
for index = 1:length(freq)
    if dispersion && strcmp(hwpType, 'RAC5_2')
        retM = [exp(-1i*(phaseShiftHWP_o(index))) 0; 0 exp(-1i*(phaseShiftHWP_e(index)))];
    else
        retM = [1 0;0 exp(1i*phaseShiftHWP(index))];
    end
    angM                = [cos(axisHWP(index)) -sin(axisHWP(index));sin(axisHWP(index)) cos(axisHWP(index))];
    JonesM              = angM'*retM*angM;
    IE                  = (E_freq(:,index));
    out                 = JonesM*IE;
    E_trans(:,index)    = out;
end

L           = size(E_trans, 2);
freqStep    = freq(2) - freq(1);
freqPd      = freqStep*(0:L-1) + freq(1);
freqSpan    = freqPd(end) - freqPd(1);
t_out       = (-L/2:L/2-1) ./ freqSpan; % time vector matching to fftshifted spectrum
E_out       = ifft(ifftshift(E_trans,2), [], 2);

for index = 1 : length(E_out)
    E_out(1:2,index)  = rotFieldBack*[E_out(1,index); E_out(2,index)];
end

checkChirpingFFT(t_out, E_out); % Checks if pulse duration is not too long
end