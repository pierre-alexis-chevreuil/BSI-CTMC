function [t_out, E_out] = quarterWP_PAC(t_in, E_in, alpha, qwpType, dispersion)
%% Code to apply a quarter waveplate to an incoming electric field. The
% code uses Jones formalism for calculations, and uses the full phase
% applied by the waveplate, i.e. it accounts for dispersion.
%
% Input:    - t_in: list of times in seconds
%           - E_in: complex electric field along x and y (therefore nx2 or
%                   2xn (conversion automatically done in code)
%           - alpha: Angle (in radian) of the waveplate
%           - qwpType: Possibilities 'RAC5_4' (achromatic)
%                                    'RSU1_4' (superachro, low wavelength)
%                                    'RSU2_4' (superachro, high wavelength,
%                                       probably the correct one)
%           - dispersion: Bool to know if could should be executed or not
%               (useful to engage or disengage dispersion in larger codes)
%
% Outputs:  - t_out: Time list
%           - E_out: Output complex electric field (2 x n)
%
% Example:
%     angle_HWP           = 10 * pi / 180;
%     angle_QWP           = 79 * pi / 180;
%     angle_parasitic_WP  = 15 * pi / 180;
%     retardance_parasitic_WP = 0 * pi / 180;
%     lambda_0            = 800e-9;
%     lambda_list         = 500e-9 : 1e-9 : 1000e-9; % A broad range: it should cover the entire spectrum. It will be used to interpolate data
%     tau_FWHM            = 10e-15;
%     thickness_window    = 5e-3;
%     t                   = (-200 : 0.1 : 200) * 1e-15;
%     dispersion          = 1;
%     hwpType             = 'RAC5_2'; % 'ideal', 'RAC5_2' 'RSU1_2', 'RSU2_2' (we have achromatic and superachro range 2 RSU2_2)
%     qwpType             = 'RAC5_4'; % 'ideal', 'RAC5_4' 'RSU1_4', 'RSU2_4' (we have achromatic and superachro range 2 RSU2_4)
%     time_window         = 2.7e-15; % To look at the instantaneous ellipticity for a particular cycle, default: [-2.7e-15   2.7e-15] (1 cycle, 1 cycle after)
%     tau                 = tau_FWHM / (2*sqrt(2*log(2)));
%     IEnv                = exp(-t.^2 ./ (2*tau^2));
%     E                   = zeros(2, length(t));
%     E(1,:)              = sqrt(IEnv) .* exp(1i*(2*pi*299792458/lambda_0 * t));
%     [~, data_UVFS]      = getRefractiveIndex('UVFS', lambda_list);
%     [~, spectral_phase] = getGDCurve(lambda_list, lambda_0, [(-8) * 1e-15, ...
%                                                         (-287)*(1e-15)^2, ...
%                                                         (-236)*(1e-15)^3 ...
%                                                         (-200)*(1e-15)^4]);
%     [t, E]              = chirperPlate(t, E, lambda_list, spectral_phase, dispersion);
%     [t, E]              = quarterWP_PAC(t, E, angle_QWP, qwpType, dispersion);
%     [t, E]              = halfWP_PAC(t, E, angle_HWP, hwpType, dispersion);
%     [t, E]              = chirperPlate(t, E, lambda_list, data_UVFS.spectral_phase_value * thickness_window, dispersion); % Beamline window
%     [t, E]              = arbitraryWP_PAC(t, E, angle_parasitic_WP, retardance_parasitic_WP);
%     [t, E]              = removeGDOffset(t, E, lambda_list, lambda_0, dispersion);
%     dispersion_values                           = getDispersionValuesFromEField(t, E(1, :), lambda_0, 3, true);
%     [ellipticity, ExHull, EyHull, orientation]  = ellipticity_finder(t, E, 0, time_window);
%     Ex                                          = real(E(1, :));
%     Ey                                          = real(E(2, :));
%     [time_max_Ex, time_max_Ey, maxEx, maxEy, ellipticity_Ex, orientation_Ex, ellipticity_Ey, orientation_Ey] = findPeakElectricField(t, E, time_window);
%     
%     disp(['Overall ellipticity....... ', num2str(ellipticity)])
%     disp(['Orientation (degrees)..... ', num2str(orientation)])
%     disp(' ')
%     disp('............. E field x .............')
%     disp(['   Max field ............. ', num2str(maxEx)])
%     disp(['   Time max field......... ', num2str(time_max_Ex*1e15), ' fs'])
%     disp(['   Ellipticity max field.. ', num2str(ellipticity_Ex)])
%     disp(['   Orientation max field.. ', num2str(orientation_Ex)])
%     disp(['   Pulse duration......... ', num2str(FWHM(t, abs(E(1, :)).^2) * 1e15), ' fs'])
%     disp(' ')
%     disp('............. E field y .............')
%     disp(['   Max field ............. ', num2str(maxEy)])
%     disp(['   Time max field......... ', num2str(time_max_Ey*1e15), ' fs'])
%     disp(['   Ellipticity max field.. ', num2str(ellipticity_Ey)])
%     disp(['   Orientation max field.. ', num2str(orientation_Ey)])
%     disp(['   Pulse duration......... ', num2str(FWHM(t, abs(E(2, :)).^2) * 1e15), ' fs'])
%     
%     subplot 221
%     plot(t * 1e15, Ex)
%     xlabel('Time (fs)')
%     ylabel('E field (o axis)')
%     grid on
%     ylim([-1 1])
%     subplot 222
%     plot(t * 1e15, Ey)
%     xlabel('Time (fs)')
%     ylabel('E field (e axis)')
%     grid on
%     ylim([-1 1])
%     subplot 223
%     plot(Ex, Ey)
%     hold on
%     plot(ExHull, EyHull, 'b--')
%     hold off
%     xlabel('Time (fs)')
%     xlabel('E field (o axis)')
%     ylabel('E field (e axis)')
%     grid on
%     xlim([-1 1])
%     ylim([-1 1])
%     axis square
%     subplot 224
%     plot3(t * 1e15, Ex, Ey);
%     xlabel('Time (fs)')
%     ylabel('E field (o axis)')
%     zlabel('E field (e axis)')
%     ylim([-1 1])
%     zlim([-1 1])
%     view(3)
%     grid on
%     drawnow
%     makeItNice('FullScreen', false)
%     sgtitle(['Simulation for ', hwpType, ' and ', qwpType, ' waveplates'], 'fontsize', 25, 'interpreter', 'none')
%
% Date: 04.02.2022
%
% Author: Pierre-Alexis Chevreuil (chpierre@phys.ethz.ch), based on a code
% from Fabian Brunner (F)

c               = 299792458;
rotField        = [cos(alpha), -sin(alpha); sin(alpha), cos(alpha)];
rotFieldBack    = [cos(-alpha), -sin(-alpha); sin(-alpha), cos(-alpha)];
E_rot           = rotField * E_in;
L               = size(E_rot, 2);
timeStep        = t_in(2) - t_in(1);
timePd          = timeStep * (0 : L-1) + t_in(1);
timeSpan        = timePd(end) - timePd(1);
freq            = (-L/2:L/2-1) / timeSpan;
E_freq          = (fftshift(fft(E_rot, [], 2), 2));
phaseShiftQWP_o = zeros(size(t_in)); % For compiler ...
phaseShiftQWP_e = zeros(size(t_in)); % For compiler ...

switch qwpType
    case 'ideal' % ideal wave plate
        phaseShiftQWP   = ones(size(freq)) * pi/2;
        axisQWP         = ones(size(freq)) * 0;

    case 'RAC5_4'
        axisQWP                 = ones(size(freq))*0; % data not available
        thickness_quartz        = 1.273e-3 / 2;
        thickness_MgF2          = 1.005e-3 / 2;
        lambda_list_for_Sellm   = 400e-9 : 1e-9 : 1400e-9;
        A_Q_o                   = 1.28604141;
        B_Q_o                   = 1.07044083;
        C_Q_o                   = 1.00585997e-2;
        D_Q_o                   = 1.10202242;
        F_Q_o                   = 100;
        n_fun_Q_o               = @(lambda) sqrt(A_Q_o + ...
                                                     B_Q_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - C_Q_o) + ...
                                                     D_Q_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - F_Q_o));
        spectralPhaseQuartzO    = 2 * pi * n_fun_Q_o(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_quartz;
        A_Q_e                   = 1.28851804;
        B_Q_e                   = 1.09509924;
        C_Q_e                   = 1.02101864e-2;
        D_Q_e                   = 1.15662475;
        F_Q_e                   = 100;
        n_fun_Q_e               = @(lambda) sqrt(A_Q_e + ...
                                                 B_Q_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - C_Q_e) + ...
                                                 D_Q_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - F_Q_e));
        spectralPhaseQuartzE    = 2 * pi * n_fun_Q_e(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_quartz;
        A1_M_o                  = 0.48755108;
        A2_M_o                  = 0.39875031;
        A3_M_o                  = 2.3120353;
        L1_M_o                  = 0.04338408;
        L2_M_o                  = 0.09461442;
        L3_M_o                  = 23.793604;
        n_fun_M_o               = @(lambda) sqrt(1 + ...
                                                 A1_M_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L1_M_o^2) + ...
                                                 A2_M_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L2_M_o^2) + ...
                                                 A3_M_o .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L3_M_o^2));
        spectralPhaseMgF2O      = 2 * pi * n_fun_M_o(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_MgF2;
        A1_M_e                  = 0.41344023;
        A2_M_e                  = 0.50497499;
        A3_M_e                  = 2.4904862;
        L1_M_e                  = 0.03684262;
        L2_M_e                  = 0.09076162;
        L3_M_e                  = 23.771995;
        n_fun_M_e               = @(lambda) sqrt(1 + ...
                                                 A1_M_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L1_M_e^2) + ...
                                                 A2_M_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L2_M_e^2) + ...
                                                 A3_M_e .* (lambda*10^6).^2 ./ ((lambda*10^6).^2 - L3_M_e^2));
        spectralPhaseMgF2E      = 2 * pi * n_fun_M_e(lambda_list_for_Sellm) ./ lambda_list_for_Sellm .* thickness_MgF2;
        phaseShiftQWP_o         = spectralPhaseMgF2E + spectralPhaseQuartzO;
        phaseShiftQWP_e         = spectralPhaseMgF2O + spectralPhaseQuartzE;
        phaseShiftQWP_o         = interp1(lambda_list_for_Sellm, phaseShiftQWP_o, c ./ freq, 'linear', 'extrap');
        phaseShiftQWP_e         = interp1(lambda_list_for_Sellm, phaseShiftQWP_e, c ./ freq, 'linear', 'extrap');
        phaseShiftQWP           = phaseShiftQWP_o - phaseShiftQWP_e; % In case we don't go for dispersion
        
    case 'RSU2_4' % LOAD QWP SPECS: (wavelength [µm], retardation [lambda], angle axis[rad])
        QWPspecs = [
        0.5    0.21231    -5.6781; ...
        0.505    0.2176    -5.4502; ...
        0.51    0.22225    -5.2362; ...
        0.515    0.22632    -5.0364; ...
        0.52    0.22988    -4.8508; ...
        0.525    0.23298    -4.6793; ...
        0.53    0.23568    -4.5215; ...
        0.535    0.23802    -4.3769; ...
        0.54    0.24004    -4.245; ...
        0.545    0.24179    -4.1251; ...
        0.55    0.24329    -4.0165; ...
        0.555    0.24457    -3.9186; ...
        0.56    0.24567    -3.8307; ...
        0.565    0.2466    -3.7519; ...
        0.57    0.24738    -3.6817; ...
        0.575    0.24804    -3.6193; ...
        0.58    0.2486    -3.5642; ...
        0.585    0.24905    -3.5155; ...
        0.59    0.24942    -3.4728; ...
        0.595    0.24973    -3.4356; ...
        0.6    0.24997    -3.4032; ...
        0.605    0.25016    -3.3752; ...
        0.61    0.2503    -3.3512; ...
        0.615    0.25041    -3.3306; ...
        0.62    0.25048    -3.3132; ...
        0.625    0.25053    -3.2986; ...
        0.63    0.25055    -3.2865; ...
        0.635    0.25056    -3.2765; ...
        0.64    0.25055    -3.2683; ...
        0.645    0.25053    -3.2619; ...
        0.65    0.25049    -3.2568; ...
        0.655    0.25045    -3.253; ...
        0.66    0.25041    -3.2502; ...
        0.665    0.25036    -3.2483; ...
        0.67    0.2503    -3.2472; ...
        0.675    0.25025    -3.2467; ...
        0.68    0.25019    -3.2467; ...
        0.685    0.25014    -3.2471; ...
        0.69    0.25008    -3.2479; ...
        0.695    0.25003    -3.2488; ...
        0.7    0.24997    -3.25; ...
        0.705    0.24992    -3.2513; ...
        0.71    0.24988    -3.2527; ...
        0.715    0.24983    -3.2541; ...
        0.72    0.24979    -3.2555; ...
        0.725    0.24975    -3.2569; ...
        0.73    0.24971    -3.2583; ...
        0.735    0.24968    -3.2595; ...
        0.74    0.24965    -3.2607; ...
        0.745    0.24963    -3.2618; ...
        0.75    0.2496    -3.2627; ...
        0.755    0.24958    -3.2636; ...
        0.76    0.24957    -3.2643; ...
        0.765    0.24955    -3.2649; ...
        0.77    0.24954    -3.2654; ...
        0.775    0.24953    -3.2658; ...
        0.78    0.24953    -3.266; ...
        0.785    0.24953    -3.2661; ...
        0.79    0.24953    -3.2662; ...
        0.795    0.24953    -3.2661; ...
        0.8    0.24953    -3.2659; ...
        0.805    0.24954    -3.2656; ...
        0.81    0.24955    -3.2653; ...
        0.815    0.24956    -3.2648; ...
        0.82    0.24957    -3.2643; ...
        0.825    0.24958    -3.2637; ...
        0.83    0.2496    -3.2631; ...
        0.835    0.24961    -3.2624; ...
        0.84    0.24963    -3.2617; ...
        0.845    0.24965    -3.261; ...
        0.85    0.24967    -3.2602; ...
        0.855    0.24969    -3.2594; ...
        0.86    0.24971    -3.2586; ...
        0.865    0.24973    -3.2577; ...
        0.87    0.24975    -3.2569; ...
        0.875    0.24978    -3.2561; ...
        0.88    0.2498    -3.2553; ...
        0.885    0.24982    -3.2545; ...
        0.89    0.24985    -3.2537; ...
        0.895    0.24987    -3.2529; ...
        0.9    0.2499    -3.2522; ...
        0.905    0.24992    -3.2515; ...
        0.91    0.24995    -3.2509; ...
        0.915    0.24997    -3.2502; ...
        0.92    0.25    -3.2497; ...
        0.925    0.25002    -3.2491; ...
        0.93    0.25005    -3.2487; ...
        0.935    0.25007    -3.2482; ...
        0.94    0.25009    -3.2479; ...
        0.945    0.25012    -3.2475; ...
        0.95    0.25014    -3.2473; ...
        0.955    0.25016    -3.2471; ...
        0.96    0.25018    -3.247; ...
        0.965    0.25021    -3.2469; ...
        0.97    0.25023    -3.2469; ...
        0.975    0.25025    -3.2469; ...
        0.98    0.25027    -3.247; ...
        0.985    0.25029    -3.2472; ...
        0.99    0.25031    -3.2475; ...
        0.995    0.25032    -3.2478; ...
        1    0.25034    -3.2482; ...
        1.005    0.25036    -3.2486; ...
        1.01    0.25038    -3.2491; ...
        1.015    0.25039    -3.2497; ...
        1.02    0.25041    -3.2503; ...
        1.025    0.25042    -3.251; ...
        1.03    0.25043    -3.2518; ...
        1.035    0.25045    -3.2526; ...
        1.04    0.25046    -3.2535; ...
        1.045    0.25047    -3.2544; ...
        1.05    0.25048    -3.2555; ...
        1.055    0.25049    -3.2565; ...
        1.06    0.2505    -3.2577; ...
        1.065    0.25051    -3.2588; ...
        1.07    0.25052    -3.2601; ...
        1.075    0.25053    -3.2614; ...
        1.08    0.25053    -3.2627; ...
        1.085    0.25054    -3.2641; ...
        1.09    0.25054    -3.2655; ...
        1.095    0.25055    -3.267; ...
        1.1    0.25055    -3.2686; ...
        1.105    0.25055    -3.2702; ...
        1.11    0.25056    -3.2718; ...
        1.115    0.25056    -3.2735; ...
        1.12    0.25056    -3.2752; ...
        1.125    0.25056    -3.2769; ...
        1.13    0.25056    -3.2787; ...
        1.135    0.25056    -3.2806; ...
        1.14    0.25056    -3.2824; ...
        1.145    0.25056    -3.2843; ...
        1.15    0.25056    -3.2863; ...
        1.155    0.25055    -3.2882; ...
        1.16    0.25055    -3.2902; ...
        1.165    0.25055    -3.2922; ...
        1.17    0.25054    -3.2943; ...
        1.175    0.25054    -3.2963; ...
        1.18    0.25053    -3.2984; ...
        1.185    0.25053    -3.3006; ...
        1.19    0.25052    -3.3027; ...
        1.195    0.25052    -3.3049; ...
        1.2    0.25051    -3.307; ...
        1.205    0.2505    -3.3092; ...
        1.21    0.25049    -3.3114; ...
        1.215    0.25049    -3.3136; ...
        1.22    0.25048    -3.3159; ...
        1.225    0.25047    -3.3181; ...
        1.23    0.25046    -3.3204; ...
        1.235    0.25045    -3.3226; ...
        1.24    0.25044    -3.3249; ...
        1.245    0.25043    -3.3272; ...
        1.25    0.25042    -3.3295; ...
        1.255    0.25041    -3.3317; ...
        1.26    0.2504    -3.334; ...
        1.265    0.25039    -3.3363; ...
        1.27    0.25037    -3.3386; ...
        1.275    0.25036    -3.3409; ...
        1.28    0.25035    -3.3432; ...
        1.285    0.25034    -3.3455; ...
        1.29    0.25033    -3.3477; ...
        1.295    0.25031    -3.35; ...
        1.3    0.2503    -3.3523; ...
        1.305    0.25029    -3.3545; ...
        1.31    0.25028    -3.3568; ...
        1.315    0.25026    -3.359; ...
        1.32    0.25025    -3.3613; ...
        1.325    0.25024    -3.3635; ...
        1.33    0.25022    -3.3657; ...
        1.335    0.25021    -3.3679; ...
        1.34    0.2502    -3.3701; ...
        1.345    0.25018    -3.3722; ...
        1.35    0.25017    -3.3744; ...
        1.355    0.25015    -3.3765; ...
        1.36    0.25014    -3.3787; ...
        1.365    0.25013    -3.3808; ...
        1.37    0.25011    -3.3829; ...
        1.375    0.2501    -3.3849; ...
        1.38    0.25009    -3.387; ...
        1.385    0.25007    -3.389; ...
        1.39    0.25006    -3.391; ...
        1.395    0.25005    -3.393; ...
        1.4    0.25003    -3.395; ...
        1.405    0.25002    -3.3969; ...
        1.41    0.25001    -3.3989; ...
        1.415    0.24999    -3.4008; ...
        1.42    0.24998    -3.4027; ...
        1.425    0.24997    -3.4045; ...
        1.43    0.24995    -3.4063; ...
        1.435    0.24994    -3.4082; ...
        1.44    0.24993    -3.4099; ...
        1.445    0.24991    -3.4117; ...
        1.45    0.2499    -3.4134; ...
        1.455    0.24989    -3.4151; ...
        1.46    0.24988    -3.4168; ...
        1.465    0.24986    -3.4185; ...
        1.47    0.24985    -3.4201; ...
        1.475    0.24984    -3.4217; ...
        1.48    0.24983    -3.4232; ...
        1.485    0.24982    -3.4248; ...
        1.49    0.24981    -3.4263; ...
        1.495    0.24979    -3.4278; ...
        1.5    0.24978    -3.4292; ...
        1.505    0.24977    -3.4306; ...
        1.51    0.24976    -3.432; ...
        1.515    0.24975    -3.4334; ...
        1.52    0.24974    -3.4347; ...
        1.525    0.24973    -3.436; ...
        1.53    0.24972    -3.4373; ...
        1.535    0.24971    -3.4385; ...
        1.54    0.2497    -3.4398; ...
        1.545    0.24969    -3.4409; ...
        1.55    0.24968    -3.4421; ...
        1.555    0.24967    -3.4432; ...
        1.56    0.24967    -3.4443; ...
        1.565    0.24966    -3.4453; ...
        1.57    0.24965    -3.4464; ...
        1.575    0.24964    -3.4474; ...
        1.58    0.24963    -3.4483; ...
        1.585    0.24963    -3.4493; ...
        1.59    0.24962    -3.4502; ...
        1.595    0.24961    -3.451; ...
        1.6    0.2496    -3.4519; ...
        1.605    0.2496    -3.4527; ...
        1.61    0.24959    -3.4534; ...
        1.615    0.24959    -3.4542; ...
        1.62    0.24958    -3.4549; ...
        1.625    0.24957    -3.4556; ...
        1.63    0.24957    -3.4562; ...
        1.635    0.24956    -3.4568; ...
        1.64    0.24956    -3.4574; ...
        1.645    0.24956    -3.458; ...
        1.65    0.24955    -3.4585; ...
        1.655    0.24955    -3.459; ...
        1.66    0.24954    -3.4594; ...
        1.665    0.24954    -3.4599; ...
        1.67    0.24954    -3.4603; ...
        1.675    0.24953    -3.4606; ...
        1.68    0.24953    -3.461; ...
        1.685    0.24953    -3.4613; ...
        1.69    0.24953    -3.4616; ...
        1.695    0.24952    -3.4618; ...
        1.7    0.24952    -3.462; ...
        1.705    0.24952    -3.4622; ...
        1.71    0.24952    -3.4624; ...
        1.715    0.24952    -3.4625; ...
        1.72    0.24952    -3.4626; ...
        1.725    0.24952    -3.4627; ...
        1.73    0.24952    -3.4627; ...
        1.735    0.24952    -3.4627; ...
        1.74    0.24952    -3.4627; ...
        1.745    0.24952    -3.4627; ...
        1.75    0.24952    -3.4626; ...
        1.755    0.24952    -3.4625; ...
        1.76    0.24952    -3.4624; ...
        1.765    0.24952    -3.4622; ...
        1.77    0.24952    -3.462; ...
        1.775    0.24952    -3.4618; ...
        1.78    0.24953    -3.4616; ...
        1.785    0.24953    -3.4613; ...
        1.79    0.24953    -3.461; ...
        1.795    0.24953    -3.4607; ...
        1.8    0.24954    -3.4603; ...
        1.805    0.24954    -3.46; ...
        1.81    0.24954    -3.4596; ...
        1.815    0.24955    -3.4592; ...
        1.82    0.24955    -3.4587; ...
        1.825    0.24955    -3.4582; ...
        1.83    0.24956    -3.4578; ...
        1.835    0.24956    -3.4572; ...
        1.84    0.24957    -3.4567; ...
        1.845    0.24957    -3.4561; ...
        1.85    0.24958    -3.4555; ...
        1.855    0.24958    -3.4549; ...
        1.86    0.24959    -3.4543; ...
        1.865    0.24959    -3.4536; ...
        1.87    0.2496    -3.453; ...
        1.875    0.2496    -3.4523; ...
        1.88    0.24961    -3.4515; ...
        1.885    0.24961    -3.4508; ...
        1.89    0.24962    -3.45; ...
        1.895    0.24963    -3.4493; ...
        1.9    0.24963    -3.4485; ...
        1.905    0.24964    -3.4476; ...
        1.91    0.24965    -3.4468; ...
        1.915    0.24965    -3.4459; ...
        1.92    0.24966    -3.445; ...
        1.925    0.24967    -3.4441; ...
        1.93    0.24967    -3.4432; ...
        1.935    0.24968    -3.4423; ...
        1.94    0.24969    -3.4413; ...
        1.945    0.2497    -3.4404; ...
        1.95    0.24971    -3.4394; ...
        1.955    0.24971    -3.4384; ...
        1.96    0.24972    -3.4374; ...
        1.965    0.24973    -3.4363; ...
        1.97    0.24974    -3.4353; ...
        1.975    0.24975    -3.4342; ...
        1.98    0.24975    -3.4331; ...
        1.985    0.24976    -3.432; ...
        1.99    0.24977    -3.4309; ...
        1.995    0.24978    -3.4298; ...
        2    0.24979    -3.4287; ...
        2.005    0.2498    -3.4275; ...
        2.01    0.24981    -3.4264; ...
        2.015    0.24981    -3.4252; ...
        2.02    0.24982    -3.424; ...
        2.025    0.24983    -3.4228; ...
        2.03    0.24984    -3.4216; ...
        2.035    0.24985    -3.4204; ...
        2.04    0.24986    -3.4192; ...
        2.045    0.24987    -3.4179; ...
        2.05    0.24988    -3.4167; ...
        2.055    0.24989    -3.4154; ...
        2.06    0.2499    -3.4142; ...
        2.065    0.24991    -3.4129; ...
        2.07    0.24992    -3.4116; ...
        2.075    0.24992    -3.4103; ...
        2.08    0.24993    -3.409; ...
        2.085    0.24994    -3.4077; ...
        2.09    0.24995    -3.4064; ...
        2.095    0.24996    -3.4051; ...
        2.1    0.24997    -3.4038; ...
        2.105    0.24998    -3.4025; ...
        2.11    0.24999    -3.4011; ...
        2.115    0.25    -3.3998; ...
        2.12    0.25001    -3.3985; ...
        2.125    0.25002    -3.3971; ...
        2.13    0.25003    -3.3958; ...
        2.135    0.25004    -3.3944; ...
        2.14    0.25005    -3.3931; ...
        2.145    0.25006    -3.3917; ...
        2.15    0.25007    -3.3904; ...
        2.155    0.25007    -3.389; ...
        2.16    0.25008    -3.3876; ...
        2.165    0.25009    -3.3863; ...
        2.17    0.2501    -3.3849; ...
        2.175    0.25011    -3.3836; ...
        2.18    0.25012    -3.3822; ...
        2.185    0.25013    -3.3808; ...
        2.19    0.25014    -3.3795; ...
        2.195    0.25015    -3.3781; ...
        2.2    0.25016    -3.3768; ...
        2.205    0.25016    -3.3754; ...
        2.21    0.25017    -3.3741; ...
        2.215    0.25018    -3.3727; ...
        2.22    0.25019    -3.3714; ...
        2.225    0.2502    -3.37; ...
        2.23    0.25021    -3.3687; ...
        2.235    0.25021    -3.3673; ...
        2.24    0.25022    -3.366; ...
        2.245    0.25023    -3.3647; ...
        2.25    0.25024    -3.3634; ...
        2.255    0.25025    -3.362; ...
        2.26    0.25025    -3.3607; ...
        2.265    0.25026    -3.3594; ...
        2.27    0.25027    -3.3581; ...
        2.275    0.25028    -3.3568; ...
        2.28    0.25028    -3.3555; ...
        2.285    0.25029    -3.3543; ...
        2.29    0.2503    -3.353; ...
        2.295    0.25031    -3.3517; ...
        2.3    0.25031    -3.3505; ...
        2.305    0.25032    -3.3492; ...
        2.31    0.25033    -3.348; ...
        2.315    0.25033    -3.3468; ...
        2.32    0.25034    -3.3456; ...
        2.325    0.25035    -3.3444; ...
        2.33    0.25035    -3.3432; ...
        2.335    0.25036    -3.342; ...
        2.34    0.25036    -3.3408; ...
        2.345    0.25037    -3.3396; ...
        2.35    0.25038    -3.3385; ...
        2.355    0.25038    -3.3373; ...
        2.36    0.25039    -3.3362; ...
        2.365    0.25039    -3.3351; ...
        2.37    0.2504    -3.334; ...
        2.375    0.2504    -3.3329; ...
        2.38    0.25041    -3.3318; ...
        2.385    0.25041    -3.3307; ...
        2.39    0.25042    -3.3297; ...
        2.395    0.25042    -3.3286; ...
        2.4    0.25043    -3.3276; ...
        2.405    0.25043    -3.3266; ...
        2.41    0.25044    -3.3256; ...
        2.415    0.25044    -3.3246; ...
        2.42    0.25045    -3.3236; ...
        2.425    0.25045    -3.3227; ...
        2.43    0.25045    -3.3217; ...
        2.435    0.25046    -3.3208; ...
        2.44    0.25046    -3.3199; ...
        2.445    0.25047    -3.319; ...
        2.45    0.25047    -3.3181; ...
        2.455    0.25047    -3.3172; ...
        2.46    0.25048    -3.3164; ...
        2.465    0.25048    -3.3156; ...
        2.47    0.25048    -3.3148; ...
        2.475    0.25049    -3.314; ...
        2.48    0.25049    -3.3132; ...
        2.485    0.25049    -3.3124; ...
        2.49    0.25049    -3.3117; ...
        2.495    0.2505    -3.311; ...
        2.5    0.2505    -3.3102; ...
        2.505    0.2505    -3.3096; ...
        2.51    0.2505    -3.3089; ...
        2.515    0.25051    -3.3082; ...
        2.52    0.25051    -3.3076; ...
        2.525    0.25051    -3.307; ...
        2.53    0.25051    -3.3064; ...
        2.535    0.25051    -3.3058; ...
        2.54    0.25052    -3.3053; ...
        2.545    0.25052    -3.3047; ...
        2.55    0.25052    -3.3042; ...
        2.555    0.25052    -3.3037; ...
        2.56    0.25052    -3.3033; ...
        2.565    0.25052    -3.3028; ...
        2.57    0.25052    -3.3024; ...
        2.575    0.25053    -3.302; ...
        2.58    0.25053    -3.3016; ...
        2.585    0.25053    -3.3012; ...
        2.59    0.25053    -3.3009; ...
        2.595    0.25053    -3.3006; ...
        2.6    0.25053    -3.3003; ...
        2.605    0.25053    -3.3; ...
        2.61    0.25053    -3.2997; ...
        2.615    0.25053    -3.2995; ...
        2.62    0.25053    -3.2993; ...
        2.625    0.25053    -3.2992; ...
        2.63    0.25053    -3.299; ...
        2.635    0.25053    -3.2989; ...
        2.64    0.25053    -3.2988; ...
        2.645    0.25053    -3.2987; ...
        2.65    0.25053    -3.2987; ...
        2.655    0.25053    -3.2987; ...
        2.66    0.25053    -3.2987; ...
        2.665    0.25053    -3.2988; ...
        2.67    0.25053    -3.2988; ...
        2.675    0.25053    -3.299; ...
        2.68    0.25053    -3.2991; ...
        2.685    0.25053    -3.2993; ...
        2.69    0.25053    -3.2995; ...
        2.695    0.25053    -3.2997; ...
        2.7    0.25053    -3.3; ...
        2.705    0.25053    -3.3003; ...
        2.71    0.25053    -3.3007; ...
        2.715    0.25053    -3.3011; ...
        2.72    0.25053    -3.3015; ...
        2.725    0.25053    -3.302; ...
        2.73    0.25052    -3.3025; ...
        2.735    0.25052    -3.3031; ...
        2.74    0.25052    -3.3037; ...
        2.745    0.25052    -3.3044; ...
        2.75    0.25052    -3.3051; ...
        2.755    0.25051    -3.3058; ...
        2.76    0.25051    -3.3066; ...
        2.765    0.25051    -3.3075; ...
        2.77    0.25051    -3.3084; ...
        2.775    0.2505    -3.3094; ...
        2.78    0.2505    -3.3104; ...
        2.785    0.2505    -3.3115; ...
        2.79    0.25049    -3.3127; ...
        2.795    0.25049    -3.3139];
        QWPspecs(:,1)   = c ./ (QWPspecs(:,1).*1e-6);      % convert to frequency
        QWPspecs(:,3)   = QWPspecs(:,3) * pi/180;         % axis data are in degrees!!! rad required
        axisQWP         = interp1(QWPspecs(:,1), QWPspecs(:,3), freq, 'linear',0);
        phaseShiftQWP   = interp1(QWPspecs(:,1), QWPspecs(:,2), freq, 'linear','extrap')*pi*2;
          
    case 'RSU1_4' % LOAD QWP SPECS: (wavelength [µm], retardation [lambda], angle axis[rad])
        QWPspecs = [
        0.28    0.1152    -6.129; ...
        0.285    0.1499    -5.438; ...
        0.29    0.1786    -4.662; ...
        0.295    0.2016    -3.854; ...
        0.3    0.2196    -3.057; ...
        0.305    0.2332    -2.303; ...
        0.31    0.2433    -1.613; ...
        0.315    0.2504    -0.9999; ...
        0.32    0.2551    -0.4705; ...
        0.325    0.258    -0.02487; ...
        0.33    0.2595    0.3405; ...
        0.335    0.2599    0.6319; ...
        0.34    0.2595    0.857; ...
        0.345    0.2586    1.024; ...
        0.35    0.2574    1.142; ...
        0.355    0.2559    1.219; ...
        0.36    0.2543    1.263; ...
        0.365    0.2526    1.28; ...
        0.37    0.251    1.276; ...
        0.375    0.2494    1.257; ...
        0.38    0.248    1.228; ...
        0.385    0.2466    1.192; ...
        0.39    0.2454    1.152; ...
        0.395    0.2442    1.11; ...
        0.4    0.2432    1.069; ...
        0.405    0.2424    1.03; ...
        0.41    0.2416    0.9944; ...
        0.415    0.241    0.9627; ...
        0.42    0.2404    0.9355; ...
        0.425    0.24    0.9131; ...
        0.43    0.2397    0.8955; ...
        0.435    0.2395    0.8827; ...
        0.44    0.2393    0.8746; ...
        0.445    0.2393    0.871; ...
        0.45    0.2393    0.8714; ...
        0.455    0.2393    0.8757; ...
        0.46    0.2395    0.8834; ...
        0.465    0.2397    0.8941; ...
        0.47    0.2399    0.9074; ...
        0.475    0.2402    0.923; ...
        0.48    0.2405    0.9404; ...
        0.485    0.2409    0.9593; ...
        0.49    0.2413    0.9795; ...
        0.495    0.2417    1; ...
        0.5    0.2422    1.022; ...
        0.505    0.2426    1.044; ...
        0.51    0.2431    1.065; ...
        0.515    0.2436    1.087; ...
        0.52    0.2442    1.108; ...
        0.525    0.2447    1.128; ...
        0.53    0.2452    1.148; ...
        0.535    0.2458    1.166; ...
        0.54    0.2463    1.184; ...
        0.545    0.2469    1.2; ...
        0.55    0.2474    1.215; ...
        0.555    0.2479    1.229; ...
        0.56    0.2485    1.241; ...
        0.565    0.249    1.252; ...
        0.57    0.2496    1.261; ...
        0.575    0.2501    1.268; ...
        0.58    0.2506    1.274; ...
        0.585    0.2511    1.278; ...
        0.59    0.2516    1.281; ...
        0.595    0.2521    1.282; ...
        0.6    0.2525    1.282; ...
        0.605    0.253    1.28; ...
        0.61    0.2534    1.276; ...
        0.615    0.2539    1.271; ...
        0.62    0.2543    1.264; ...
        0.625    0.2547    1.256; ...
        0.63    0.2551    1.246; ...
        0.635    0.2555    1.235; ...
        0.64    0.2558    1.222; ...
        0.645    0.2562    1.208; ...
        0.65    0.2565    1.193; ...
        0.655    0.2568    1.177; ...
        0.66    0.2571    1.159; ...
        0.665    0.2574    1.141; ...
        0.67    0.2577    1.121; ...
        0.675    0.2579    1.1; ...
        0.68    0.2581    1.078; ...
        0.685    0.2584    1.055; ...
        0.69    0.2586    1.031; ...
        0.695    0.2588    1.006; ...
        0.7    0.2589    0.9803; ...
        0.705    0.2591    0.9537; ...
        0.71    0.2592    0.9264; ...
        0.715    0.2594    0.8983; ...
        0.72    0.2595    0.8695; ...
        0.725    0.2596    0.8401; ...
        0.73    0.2596    0.81; ...
        0.735    0.2597    0.7793; ...
        0.74    0.2598    0.7481; ...
        0.745    0.2598    0.7163; ...
        0.75    0.2598    0.6841; ...
        0.755    0.2599    0.6514; ...
        0.76    0.2599    0.6182; ...
        0.765    0.2598    0.5847; ...
        0.77    0.2598    0.5508; ...
        0.775    0.2598    0.5165; ...
        0.78    0.2597    0.4819; ...
        0.785    0.2597    0.4471; ...
        0.79    0.2596    0.412; ...
        0.795    0.2595    0.3766; ...
        0.8    0.2594    0.341; ...
        0.805    0.2593    0.3053; ...
        0.81    0.2592    0.2694; ...
        0.815    0.2591    0.2333; ...
        0.82    0.259    0.1971; ...
        0.825    0.2588    0.1608; ...
        0.83    0.2587    0.1243; ...
        0.835    0.2585    0.08786; ...
        0.84    0.2583    0.05133; ...
        0.845    0.2582    0.01475; ...
        0.85    0.258    -0.02186; ...
        0.855    0.2578    -0.05847; ...
        0.86    0.2576    -0.09508; ...
        0.865    0.2574    -0.1317; ...
        0.87    0.2572    -0.1682; ...
        0.875    0.2569    -0.2048; ...
        0.88    0.2567    -0.2412; ...
        0.885    0.2565    -0.2776; ...
        0.89    0.2562    -0.3139; ...
        0.895    0.256    -0.3502; ...
        0.9    0.2557    -0.3863; ...
        0.905    0.2554    -0.4224; ...
        0.91    0.2552    -0.4583; ...
        0.915    0.2549    -0.4941; ...
        0.92    0.2546    -0.5298; ...
        0.925    0.2543    -0.5653; ...
        0.93    0.254    -0.6007; ...
        0.935    0.2537    -0.6359; ...
        0.94    0.2534    -0.671; ...
        0.945    0.2531    -0.7059; ...
        0.95    0.2528    -0.7407; ...
        0.955    0.2525    -0.7753; ...
        0.96    0.2522    -0.8097; ...
        0.965    0.2519    -0.8439; ...
        0.97    0.2515    -0.878; ...
        0.975    0.2512    -0.9118; ...
        0.98    0.2509    -0.9455; ...
        0.985    0.2505    -0.979; ...
        0.99    0.2502    -1.012; ...
        0.995    0.2499    -1.045; ...
        1    0.2495    -1.078; ...
        1.005    0.2492    -1.111; ...
        1.01    0.2488    -1.143; ...
        1.015    0.2485    -1.175; ...
        1.02    0.2481    -1.207; ...
        1.025    0.2477    -1.239; ...
        1.03    0.2474    -1.271; ...
        1.035    0.247    -1.302; ...
        1.04    0.2467    -1.333; ...
        1.045    0.2463    -1.364; ...
        1.05    0.2459    -1.395; ...
        1.055    0.2456    -1.425; ...
        1.06    0.2452    -1.456; ...
        1.065    0.2448    -1.486; ...
        1.07    0.2445    -1.515; ...
        1.075    0.2441    -1.545; ...
        1.08    0.2437    -1.574; ...
        1.085    0.2433    -1.604; ...
        1.09    0.243    -1.632; ...
        1.095    0.2426    -1.661; ...
        1.1    0.2422    -1.69; ...
        1.105    0.2418    -1.718; ...
        1.11    0.2414    -1.746; ...
        1.115    0.2411    -1.774; ...
        1.12    0.2407    -1.801; ...
        1.125    0.2403    -1.829; ...
        1.13    0.2399    -1.856; ...
        1.135    0.2395    -1.883; ...
        1.14    0.2392    -1.909; ...
        1.145    0.2388    -1.936; ...
        1.15    0.2384    -1.962; ...
        1.155    0.238    -1.988; ...
        1.16    0.2376    -2.014; ...
        1.165    0.2373    -2.039; ...
        1.17    0.2369    -2.065; ...
        1.175    0.2365    -2.09; ...
        1.18    0.2361    -2.115; ...
        1.185    0.2357    -2.139; ...
        1.19    0.2353    -2.164; ...
        1.195    0.235    -2.188; ...
        1.2    0.2346    -2.212; ...
        1.205    0.2342    -2.236; ...
        1.21    0.2338    -2.26; ...
        1.215    0.2335    -2.284; ...
        1.22    0.2331    -2.307; ...
        1.225    0.2327    -2.33; ...
        1.23    0.2323    -2.353; ...
        1.235    0.232    -2.375; ...
        1.24    0.2316    -2.398; ...
        1.245    0.2312    -2.42; ...
        1.25    0.2308    -2.442; ...
        1.255    0.2305    -2.464; ...
        1.26    0.2301    -2.486; ...
        1.265    0.2297    -2.507; ...
        1.27    0.2293    -2.529; ...
        1.275    0.229    -2.55; ...
        1.28    0.2286    -2.571; ...
        1.285    0.2282    -2.592; ...
        1.29    0.2279    -2.612; ...
        1.295    0.2275    -2.633; ...
        1.3    0.2272    -2.653; ...
        1.305    0.2268    -2.673; ...
        1.31    0.2264    -2.693; ...
        1.315    0.2261    -2.712; ...
        1.32    0.2257    -2.732; ...
        1.325    0.2254    -2.751; ...
        1.33    0.225    -2.77; ...
        1.335    0.2247    -2.789; ...
        1.34    0.2243    -2.808; ...
        1.345    0.2239    -2.827; ...
        1.35    0.2236    -2.845; ...
        1.355    0.2232    -2.864; ...
        1.36    0.2229    -2.882; ...
        1.365    0.2226    -2.9; ...
        1.37    0.2222    -2.918; ...
        1.375    0.2219    -2.935; ...
        1.38    0.2215    -2.953; ...
        1.385    0.2212    -2.97; ...
        1.39    0.2208    -2.987; ...
        1.395    0.2205    -3.005; ...
        1.4    0.2202    -3.021; ...
        1.405    0.2198    -3.038; ...
        1.41    0.2195    -3.055; ...
        1.415    0.2192    -3.071; ...
        1.42    0.2188    -3.088; ...
        1.425    0.2185    -3.104; ...
        1.43    0.2182    -3.12; ...
        1.435    0.2179    -3.136; ...
        1.44    0.2175    -3.151; ...
        1.445    0.2172    -3.167; ...
        1.45    0.2169    -3.182; ...
        1.455    0.2166    -3.198; ...
        1.46    0.2162    -3.213; ...
        1.465    0.2159    -3.228; ...
        1.47    0.2156    -3.243; ...
        1.475    0.2153    -3.257; ...
        1.48    0.215    -3.272; ...
        1.485    0.2147    -3.287; ...
        1.49    0.2144    -3.301; ...
        1.495    0.214    -3.315];
        QWPspecs(:,1)   = c ./ (QWPspecs(:,1).*1e-6);      % convert to frequency
        QWPspecs(:,3)   = QWPspecs(:,3) * pi/180;         % axis data are in degrees!!! rad required
        axisQWP         = interp1(QWPspecs(:,1), QWPspecs(:,3), freq, 'linear',0);
        phaseShiftQWP   = interp1(QWPspecs(:,1), QWPspecs(:,2), freq, 'linear','extrap')*pi*2;
        
    otherwise
        error('Waveplate %s not supported', qwpType);
end

E_trans = complex(zeros(size(E_freq)));
for index = 1:length(freq)
    if dispersion && strcmp(qwpType, 'RAC5_4')
        retM = [exp(-1i*(phaseShiftQWP_o(index))) 0; 0 exp(-1i*(phaseShiftQWP_e(index)))];
    else
        retM = [1 0;0 exp(1i*phaseShiftQWP(index))];
    end
    angM                = [cos(axisQWP(index)) -sin(axisQWP(index));sin(axisQWP(index)) cos(axisQWP(index))];
    JonesM              = angM'*retM*angM;
    IE                  = (E_freq(:,index));
    out                 = JonesM*IE;
    E_trans(:,index)    = out;
end

L           = size(E_trans, 2);
freqStep    = freq(2) - freq(1);
freqPd      = freqStep*(0:L-1) + freq(1);
freqSpan    = freqPd(end) - freqPd(1);
t_out       = (-L/2:L/2-1) ./ freqSpan; % time vector matching to fftshifted spectrum
E_out       = ifft(ifftshift(E_trans,2), [], 2);

for index = 1 : length(E_out)
    E_out(1:2,index)  = rotFieldBack*[E_out(1,index); E_out(2,index)];
end

checkChirpingFFT(t_out, E_out); % Checks if pulse duration is not too long
end